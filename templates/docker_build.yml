variables:
  DOCKERFILE: "Dockerfile"
  SERVICE: ""
  IMAGE_TAG: ""

.docker_build:
  stage: build
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    #--Wait for docker daemon to start
    - |
      for i in $(seq 1 30); do
        docker info && break
        echo "Docker starting ..."
        sleep 1s
      done
    - IMAGE="$CI_REGISTRY_IMAGE/$SERVICE:$IMAGE_TAG"
    - docker build -f $DOCKERFILE --build-arg GITLAB_REGISTRY_AUTH_TOKEN=$CI_JOB_TOKEN -t $IMAGE_URI .
    - docker push $IMAGE_URI
  after_script:
    - docker logout $CI_REGISTRY
